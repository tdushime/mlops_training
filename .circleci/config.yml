version: 2.1
jobs:
  staging_deployment:
    docker:
      - image: circleci/python:3.8
    working_directory: ~/app
    #working_directory
    steps:
      - checkout
      - setup_remote_docker:
        version: 19.03.13
      - run: 
        name: Install dependencies
        command: |
          pip install -r requirements.txt
      - run: 
        name: Run Tests
        command: |
          pytest tests/test_app.py
      - run:
          name; build Docker Image
          command: |
            docker build -t mlops_demo .
      - run: 
          name: Build Docker Image
          Command: |
            docker tag mlops_demo: latest 948624447504.dkr.ecr.us-east-1.amazonaws.com/mlops_demo: latest
      - run: 
        name: Deploy to Staging
        command: |
          sudo pip install awscli
          eval $(aws ecr get-login --no-include-email --region us-east-1)
          aws ecr get-login --no-include-email --region us-east-1
          docker push 948624447504dkr.ecr.us-east-1.amazonaws.com/mlops_demo: latest

workflows:
  version: 2
  build-and-deploy:
    jobs:
      - staging_deployment:
        filters:
          brances:
            only:
              - main